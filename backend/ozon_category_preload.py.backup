"""\nСистема предзагрузки категорий Ozon\n"""\n\nfrom motor.motor_asyncio import AsyncIOMotorDatabase\nfrom datetime import datetime\nfrom typing import List, Dict, Any\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n\nclass OzonCategoryManager:\n    """Менеджер категорий Ozon с кэшированием в БД"""\n    \n    def __init__(self, db: AsyncIOMotorDatabase):\n        self.db = db\n        self.collection = db.ozon_categories_cache\n    \n    async def preload_from_api(self, connector) -> Dict[str, Any]:\n        """Предзагрузка категорий с API Ozon"""\n        logger.info("[OzonCategoryManager] Preloading categories from API")\n        \n        try:\n            categories = await connector.get_categories()\n            \n            saved_count = 0\n            for category in categories:\n                category['loaded_at'] = datetime.utcnow()\n                category['source'] = 'api'\n                category['marketplace'] = 'ozon'\n                \n                await self.collection.replace_one(\n                    {\n                        'marketplace': 'ozon',\n                        'category_id': category['category_id']\n                    },\n                    category,\n                    upsert=True\n                )\n                saved_count += 1\n            \n            logger.info(f"[OzonCategoryManager] Saved {saved_count} categories to DB")\n            \n            return {\n                'success': True,\n                'loaded': saved_count,\n                'message': f'Загружено {saved_count} категорий Ozon'\n            }\n            \n        except Exception as e:\n            logger.error(f"[OzonCategoryManager] Preload failed: {e}")\n            return {\n                'success': False,\n                'error': str(e)\n            }\n    \n    async def get_all_categories(self) -> List[Dict[str, Any]]:\n        """Получить все категории из БД"""\n        try:\n            categories = await self.collection.find({'marketplace': 'ozon'}).to_list(length=20000)\n            \n            for cat in categories:\n                if '_id' in cat:\n                    cat.pop('_id')\n            \n            logger.info(f"[OzonCategoryManager] Retrieved {len(categories)} categories from DB")\n            return categories\n            \n        except Exception as e:\n            logger.error(f"[OzonCategoryManager] Failed to get categories: {e}")\n            return []\n    \n    async def search_categories(self, query: str) -> List[Dict[str, Any]]:\n        """Поиск категорий в БД"""\n        try:\n            categories = await self.collection.find({\n                'marketplace': 'ozon',\n                'name': {'$regex': query, '$options': 'i'}\n            }).limit(100).to_list(100)\n            \n            for cat in categories:\n                if '_id' in cat:\n                    cat.pop('_id')\n            \n            logger.info(f"[OzonCategoryManager] Search '{query}': found {len(categories)} categories")\n            return categories\n            \n        except Exception as e:\n            logger.error(f"[OzonCategoryManager] Search failed: {e}")\n            return []\n    \n    async def get_stats(self) -> Dict[str, Any]:\n        """Статистика загруженных категорий"""\n        try:\n            total = await self.collection.count_documents({'marketplace': 'ozon'})\n            \n            last_updated = await self.collection.find_one(\n                {'marketplace': 'ozon'},\n                sort=[('loaded_at', -1)]\n            )\n            \n            return {\n                'total': total,\n                'last_updated': last_updated.get('loaded_at') if last_updated else None\n            }\n            \n        except Exception as e:\n            logger.error(f"[OzonCategoryManager] Stats failed: {e}")\n            return {\n                'total': 0,\n                'last_updated': None\n            }\n