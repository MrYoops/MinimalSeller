# üîß –û—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞–∫–∞–∑–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ (Ozon, WB, Yandex):
1. ‚ùå –ó–∞–∫–∞–∑—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. ‚ùå –ü—Ä–∏ —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–∫–∞–∑ –ø–æ—è–≤–ª—è–ª—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑)
3. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## –†–µ—à–µ–Ω–∏–µ

### 1. –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚úÖ

**–°–æ–∑–¥–∞–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å** –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö `orders_fbs` –∏ `orders_fbo`:
- –ü–æ–ª—è: `external_order_id` + `seller_id`
- –¢–∏–ø: `unique`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: **–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–µ–ø–µ—Ä—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î**

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ ‚úÖ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ–∞–π–ª—ã:
- `/app/backend/fbs_orders_routes.py` (endpoint `/api/orders/fbs/import`)
- `/app/backend/fbo_orders_routes.py` (endpoint `/api/orders/fbo/import`)

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**

#### –≠—Ç–∞–ø 1: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –±–∞—Ç—á–∞ –æ—Ç API
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ –∑–∞–∫–∞–∑–æ–≤ –æ—Ç API
seen_external_ids = set()
for order in mp_orders:
    if external_id in seen_external_ids:
        # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
        continue
    seen_external_ids.add(external_id)
```

#### –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ –ë–î
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–∫–∞–∑
existing = await db.orders_fbs.find_one({
    "external_order_id": external_id,
    "seller_id": seller_id
})

if existing:
    # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –∑–∞–∫–∞–∑ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    continue
```

#### –≠—Ç–∞–ø 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
```python
try:
    await db.orders_fbs.insert_one(order_doc)
except Exception as e:
    if "duplicate key error" in str(e):
        # –ó–∞—â–∏—Ç–∞ –∏–Ω–¥–µ–∫—Å–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ - –¥—É–±–ª–∏–∫–∞—Ç
        skipped += 1
        continue
```

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –≤ UI ‚úÖ

–¢–µ–ø–µ—Ä—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏–º–ø–æ—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è:
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ **–Ω–æ–≤—ã—Ö** –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- ‚ÑπÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ **–ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö** –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ (–¥–ª—è FBS)

### 4. –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ‚úÖ

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: `/app/fix_duplicate_orders.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ `(external_order_id + seller_id)`
2. –û—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∑–∞–∫–∞–∑ (–ø–æ `created_at`)
3. –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏
4. –°–æ–∑–¥–∞—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
5. –í—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç

**–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å:**
```bash
cd /app
python3 fix_duplicate_orders.py
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –°—Ç–∞—Ç—É—Å: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ `/app/backend/order_sync_scheduler.py` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- **–ß–∞—Å—Ç–æ—Ç–∞:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- **–ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç:**
  - –ù–æ–≤—ã–µ FBS –∑–∞–∫–∞–∑—ã ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ + —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
  - –ù–æ–≤—ã–µ FBO –∑–∞–∫–∞–∑—ã ‚Üí —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
  - –°–ø–∏—Å–∞–Ω–∏–µ/–≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
```bash
tail -f /var/log/supervisor/backend.out.log | grep OrderSync
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†—É—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª "–ó–∞–∫–∞–∑—ã FBS"
2. –ù–∞–∂–∞—Ç—å "–ò–ú–ü–û–†–¢ –ó–ê–ö–ê–ó–û–í"
3. –í—ã–±—Ä–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∏ –ø–µ—Ä–∏–æ–¥
4. –ù–∞–∂–∞—Ç—å "–ó–ê–ì–†–£–ó–ò–¢–¨ –ó–ê–ö–ê–ó–´"
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–≥—Ä—É–∑—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã, –¥—É–±–ª–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≥–æ –∂–µ –ø–µ—Ä–∏–æ–¥–∞
1. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –°—Ü–µ–Ω–∞—Ä–∏–π 1 —Å —Ç–µ–º –∂–µ –ø–µ—Ä–∏–æ–¥–æ–º
2. **–û–∂–∏–¥–∞–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:** "–í—Å–µ –∑–∞–∫–∞–∑—ã —É–∂–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ä–∞–Ω–µ–µ (–¥—É–±–ª–∏–∫–∞—Ç–æ–≤: X)"
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –ù–ï –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ Ozon/WB
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å –¥–æ 5 –º–∏–Ω—É—Ç
3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É "–ó–∞–∫–∞–∑—ã FBS"
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –†–µ—à–µ–Ω–∏–µ |
|----------|--------|---------|
| –î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ (–±–∞—Ç—á + –ë–î + –∏–Ω–¥–µ–∫—Å) |
| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç) |
| –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ë–î | ‚úÖ –°–æ–∑–¥–∞–Ω | `(external_order_id + seller_id)` |
| –°–∫—Ä–∏–ø—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤ | `/app/fix_duplicate_orders.py` |
| UI –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å | ‚úÖ –£–ª—É—á—à–µ–Ω–æ | –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ |

## –ò—Ç–æ–≥

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:**
- –î—É–±–ª–∏–∫–∞—Ç—ã –±–æ–ª—å—à–µ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã (3 —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
- –ï—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-01-XX  
**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `/app/backend/fbs_orders_routes.py`
- `/app/backend/fbo_orders_routes.py`
- `/app/frontend/src/components/orders/ImportOrdersModal.jsx`
- `/app/fix_duplicate_orders.py` (–Ω–æ–≤—ã–π)
